<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Ti·∫øt Phim</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .seat.booked {
            background-color: gray; /* Ho·∫∑c m√†u gh·∫ø ƒë√£ ƒë·∫∑t */
            pointer-events: none; /* Ch·∫∑n click */
            }

        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h2 {
            color: #007bff;
            font-weight: bold;
        }

        .movie-info {
            margin-bottom: 15px;
            font-size: 18px;
        }

        /* ‚úÖ Su·∫•t chi·∫øu m√†u xanh n∆∞·ªõc bi·ªÉn */
        .showtime-card {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: 0.3s;
            color: white;
            background-color: #007bff; /* Xanh n∆∞·ªõc bi·ªÉn */
            font-weight: bold;
        }

        /* ‚úÖ Khi b·∫•m v√†o, m√†u ƒë·∫≠m h∆°n */
        .showtime-card.active {
            background-color: #0056b3; /* Xanh ƒë·∫≠m h∆°n */
            transform: scale(1.05);
        }

        .seat-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }

        .seat-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
        }

        .seat {
            width: 40px;
            height: 40px;
            margin: 5px;
            background-color: #6c757d;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .seat.booked {
            background-color: #dc3545;
            cursor: not-allowed;
        }

        .seat.selected {
            background-color: #343a40;
        }

        .info-box {
            margin-top: 15px;
            font-size: 18px;
        }

        .selected-seats {
            color: #28a745;
        }

        .total-price {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 id="movie-title">ƒêang t·∫£i...</h2>
    <p class="movie-info" id="movie-genre"></p>
    <p class="movie-info" id="movie-year"></p>

    <h3 class="mt-4">Su·∫•t chi·∫øu:</h3>
    <div id="showtime-list" class="mt-3"></div>

    <h3 class="mt-4">Ch·ªçn gh·∫ø:</h3>
    <div id="seat-list" class="seat-container"></div>

    <h3 class="mt-4">Th√¥ng tin ƒë·∫∑t v√©:</h3>
    <p class="info-box">Gh·∫ø ƒë√£ ch·ªçn: <span class="selected-seats" id="selected-seats">Kh√¥ng c√≥</span></p>
    <p class="info-box">T·ªïng ti·ªÅn: <span class="total-price" id="total-price">0 VND</span></p>

    <!-- N√∫t Thanh to√°n -->
    <button id="pay-button" class="btn btn-primary mt-3" onclick="processPayment()">Thanh to√°n</button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
    const params = new URLSearchParams(window.location.search);
    const movieId = params.get("id");

    if (!movieId) {
        alert("Kh√¥ng t√¨m th·∫•y phim!");
        return;
    }

    fetch(`/api/movies/${movieId}`)
        .then(response => response.json())
        .then(movie => {
            document.getElementById("movie-title").textContent = movie.title;
            document.getElementById("movie-genre").textContent = `üé≠ Th·ªÉ lo·∫°i: ${movie.genre}`;
            document.getElementById("movie-year").textContent = `üìÖ NƒÉm ph√°t h√†nh: ${movie.releaseYear}`;
        })
        .catch(error => console.error("L·ªói khi l·∫•y th√¥ng tin phim:", error));

    fetch(`/api/movies/${movieId}/showtimes`)
        .then(response => response.json())
        .then(showtimes => {
            const showtimeList = document.getElementById("showtime-list");
            showtimeList.innerHTML = "";

            showtimes.forEach(showtime => {
                const div = document.createElement("div");
                div.className = "showtime-card";
                div.textContent = `üçø Ph√≤ng ${showtime.idroom} - ‚è∞ ${showtime.time}`;
                div.dataset.idroom = showtime.idroom;
                div.dataset.idshowtime = showtime.id;

                div.addEventListener("click", function() {
                    document.querySelectorAll(".showtime-card").forEach(card => card.classList.remove("active"));
                    div.classList.add("active");
                    loadSeats(showtime.idroom);
                });

                showtimeList.appendChild(div);
            });
        })
        .catch(error => console.error("L·ªói khi l·∫•y su·∫•t chi·∫øu:", error));
});

function loadSeats(idroom) {
    fetch(`/api/seats/room/${idroom}`)
        .then(response => response.json())
        .then(seats => {
            const seatList = document.getElementById("seat-list");
            seatList.innerHTML = "";

            let seatRows = {};

            seats.forEach(seat => {
                if (!seatRows[seat.seatRow]) {
                    seatRows[seat.seatRow] = document.createElement("div");
                    seatRows[seat.seatRow].className = "seat-row";
                    seatRows[seat.seatRow].innerHTML = `<strong>${seat.seatRow}</strong>`;
                    seatList.appendChild(seatRows[seat.seatRow]);
                }

                const seatDiv = document.createElement("div");
                seatDiv.className = `seat ${seat.status ? "booked" : "available"}`;
                seatDiv.textContent = seat.number;
                seatDiv.dataset.seatNumber = `${seat.seatRow}${seat.number}`;
                seatDiv.dataset.idseat = seat.id;

                if (!seat.status) {
                    seatDiv.addEventListener("click", function() {
                        seatDiv.classList.toggle("selected");
                        updateSelectedSeats();
                    });
                }

                seatRows[seat.seatRow].appendChild(seatDiv);
            });

            // G·ªçi h√†m load gh·∫ø ƒë√£ ƒë·∫∑t
            loadBookedSeats(idroom);
        })
        .catch(error => console.error("L·ªói khi l·∫•y gh·∫ø:", error));
}

function updateSelectedSeats() {
    const selectedSeats = document.querySelectorAll(".seat.selected");
    const seatNames = Array.from(selectedSeats).map(seat => seat.dataset.seatNumber);
    const totalPrice = seatNames.length * 70000;

    document.getElementById("selected-seats").textContent = seatNames.length ? seatNames.join(", ") : "Kh√¥ng c√≥";
    document.getElementById("total-price").textContent = totalPrice.toLocaleString() + " VND";
}

function processPayment() {
    const selectedSeats = document.querySelectorAll(".seat.selected");
    const activeShowtime = document.querySelector(".showtime-card.active");

    if (!activeShowtime) {
        alert("B·∫°n ch∆∞a ch·ªçn su·∫•t chi·∫øu!");
        return;
    }

    const idShowtime = parseInt(activeShowtime.dataset.idshowtime);
    const idRoom = parseInt(activeShowtime.dataset.idroom);

    if (selectedSeats.length === 0) {
        alert("B·∫°n ch∆∞a ch·ªçn gh·∫ø n√†o!");
        return;
    }

    const seatData = Array.from(selectedSeats).map(seat => ({
        idSeat: parseInt(seat.dataset.idseat),
        idRoom: idRoom,
        idShowtime: idShowtime,
        date: new Date().toISOString().split('T')[0]
    }));

    fetch("/api/tickets/buy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(seatData)
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        alert(data.message || "Thanh to√°n th√†nh c√¥ng!");

        // C·∫≠p nh·∫≠t giao di·ªán: Ch·∫∑n ch·ªçn l·∫°i gh·∫ø
        selectedSeats.forEach(seat => {
            seat.classList.remove("selected");
            seat.classList.add("booked");
            seat.removeEventListener("click", toggleSeatSelection);
        });

        // X√≥a danh s√°ch gh·∫ø ƒë√£ ch·ªçn
        updateSelectedSeats();

        // T·ª± ƒë·ªông l√†m m·ªõi trang ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i gh·∫ø
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    } else {
        alert(data.message || "C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t v√©!");
    }
})
.catch(error => {
    console.error("L·ªói khi ƒë·∫∑t v√©:", error);
    alert("C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t v√©, vui l√≤ng th·ª≠ l·∫°i!");
});

}

// X·ª≠ l√Ω ch·ªçn gh·∫ø
function toggleSeatSelection(event) {
    const seat = event.target;
    if (!seat.classList.contains("booked")) {
        seat.classList.toggle("selected");
        updateSelectedSeats();
    }
}

// L·∫•y danh s√°ch gh·∫ø ƒë√£ ƒë·∫∑t
function loadBookedSeats(idroom) {
    const activeShowtime = document.querySelector(".showtime-card.active");
    if (!activeShowtime) return;

    const idShowtime = parseInt(activeShowtime.dataset.idshowtime);

    fetch(`/api/tickets/booked?idRoom=${idroom}&idShowtime=${idShowtime}`)
    .then(response => response.json())
    .then(bookedSeats => {
        bookedSeats.forEach(ticket => {
            const seat = document.querySelector(`.seat[data-idseat="${ticket.idSeat}"]`);
            if (seat) {
                seat.classList.add("booked");
                seat.removeEventListener("click", toggleSeatSelection);
            }
        });
    })
    .catch(error => console.error("L·ªói khi t·∫£i gh·∫ø ƒë√£ ƒë·∫∑t:", error));
}

document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const movieId = params.get("id");

    if (movieId) {
        fetch(`/api/movies/${movieId}`)
            .then(response => response.json())
            .then(movie => {
                document.getElementById("movie-title").textContent = movie.title;
                document.getElementById("movie-genre").textContent = `üé≠ Th·ªÉ lo·∫°i: ${movie.genre}`;
                document.getElementById("movie-year").textContent = `üìÖ NƒÉm ph√°t h√†nh: ${movie.releaseYear}`;
            })
            .catch(error => console.error("L·ªói khi l·∫•y th√¥ng tin phim:", error));
    }
});


</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
